<?php

add_action('admin_menu', 'prepear_setup_menu');
add_action('wp_ajax_nopriv_prpr_verify_domain', 'prpr_verify_domain');

function prepear_setup_menu()
{
    $white_icon = 'PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMThweCIgaGVpZ2h0PSIyMHB4IiB2aWV3Qm94PSIwIDAgMTggMjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8dGl0bGU+d2hpdGU8L3RpdGxlPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9Ii0iIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0zNS4wMDAwMDAsIC0yMy4wMDAwMDApIiBmaWxsPSIjRkZGRkZGIj4KICAgICAgICAgICAgPHBhdGggZD0iTTQ3LjA4NTAwNzYsMjcuNDU0NjAzMSBDNDcuMDcyMDQxMywyNy40MjM3Mzk4IDQ3LjA1NjIzODYsMjcuMzk0NTIyNiA0Ny4wNDI0NjE5LDI3LjM2MzI0NzggQzQ4LjMwMTQwNjcsMjcuMDIwMDQ3OSA0OS42OTI0NDU0LDI3LjUwMTkyNjkgNTAuNDYwNjk3NSwyOC42NTk5MTc5IEM1MS4yMzE3ODYsMjkuODIyMDI0MSA1MS4xNDU0NzkyLDMxLjMxOTkyMyA1MC4zNTE2OTk3LDMyLjM3NzA5MzkgTDQ3LjA4NTAwNzYsMjcuNDU0NjAzMSBaIE00NS41NTMzNjU3LDI5LjM1MzMxMzQgQzQ1LjUzNTk0MjMsMjkuNzY5NzYyMyA0NS41MDU5NTc4LDMwLjE4NjIxMTEgNDUuNDgxMjQwOCwzMC42MDIyNDg0IEM0NS4zNjczODA3LDMyLjI2NzYzMjEgNDUuMjIzNTM2LDMzLjkzMjYwNDMgNDUuMDY1OTE0NiwzNS41OTcxNjUgTDQ1LjAwODc4MiwzNi4yMjE0MjY3IEw0NC45MjczMzc1LDM2LjY3MDc5NjQgTDQ0Ljc5NTY0ODgsMzcuMDkwNTM3MyBDNDQuNzI5NjAxOCwzNy4yMjEzOTc3IDQ0LjY3NjExNTksMzcuMzUzOTA0MSA0NC42MTU3NDE2LDM3LjQ4MTg4NCBDNDQuMzUzNTc5NiwzNy45ODgwNDIxIDQzLjk1ODkxODUsMzguNDAyNDMzNCA0My41MTI3OTc0LDM4LjcxMDY1NDkgQzQyLjYwODM5OTQsMzkuMzMyMDM2IDQxLjUxMDMxNzYsMzkuNDg2MzUyNSA0MC41MjQ4ODAzLDM5LjEzNzgwMyBDMzkuNTMzMzY1MSwzOC44MDQ4OTA4IDM4Ljc1NDU3NzksMzguMDA0MDkxIDM4LjQwOTc1NTksMzYuOTUxODU4MiBDMzguMjM5OTc4NywzNi40MzA4ODU3IDM4LjE3NTU1MjUsMzUuODU4ODg1OCAzOC4yNzA3NzM2LDM1LjI5NTExNjIgQzM4LjI5OTU0MjUsMzUuMTU2NDM3MSAzOC4zMzY0MTU0LDM1LjAxODE2OTUgMzguMzYyNzUzMSwzNC44NzMzMTc3IEwzOC41MDk0MzQyLDM0LjQ1ODkyNjUgTDM4LjcxNDA1ODMsMzQuMDUxOTQyNCBMMzkuMDQzMDc3NiwzMy41MjE1MDUyIEMzOS45MTU0NjUxLDMyLjEwMzQzOTMgNDAuNzk5MTk4MiwzMC42OTMxOTIyIDQxLjcwNjgzNzgsMjkuMzAxNDYzMSBDNDEuOTM2NTg0LDI4Ljk1NTc5NDEgNDIuMTYyMjc4MywyOC42MDcyNDQ2IDQyLjM5ODEwMjYsMjguMjY2MTAyMiBMNDIuNzQzMzI5OCwyNy43NjI0MTMxIEM0Mi44MzEyNTczLDI3LjY1Nzg4OTQgNDIuOTA3NDM0MiwyNy41MzQ0MzYyIDQzLjAxNjAyNjgsMjcuNDU4NzE4MyBDNDMuNDAwOTYzMywyNy4wODQ2NTUgNDMuOTkxMzM0MiwyNy4wMDQ4MjIgNDQuNTI0MTY3MywyNy4xNjgxOTE3IEM0NS4wNDQ4NDQ0LDI3LjM2ODE4NTkgNDUuNDY1NDM4MSwyNy43OTYxNTcgNDUuNTQ2ODgyNiwyOC4zMzExMjA5IEM0NS41ODc0MDIyLDI4LjQ1Nzg2NjIgNDUuNTc0MDMwNywyOC42MDMxMjk1IDQ1LjU4MDkxOTEsMjguNzQwNTc0IEw0NS41NTMzNjU3LDI5LjM1MzMxMzQgWiBNNTIuMTIzNjIyOSwyNy41MjE2Nzk0IEM1MC44NDc2NTk5LDI1LjU5OTEwMTUgNDguNTIzODU5NCwyNC44MTU5OTY2IDQ2LjQzODcxOTUsMjUuNDIyNTYzNCBMNDYuNzk1Njk3NCwyMy41NjA0Nzc2IEw0NS4yMTg2NzM2LDIzIEw0My45OTM3NjU0LDI1LjM4Mzg4MTQgQzQzLjgwOTgwNjMsMjUuMzgxODIzOCA0My42MjU4NDcyLDI1LjM4ODgxOTUgNDMuNDQyNjk4NSwyNS40MTc2MjUzIEM0Mi44OTQ4NzMyLDI1LjQ5MjkzMTcgNDIuMzU4Nzk4NSwyNS43MzA3ODQ5IDQxLjkyNTIzODUsMjYuMDgwMTU3NSBDNDEuNjk1MDg3MSwyNi4yNDU1ODQ4IDQxLjUyMDQ0NzUsMjYuNDU2Mjc4MiA0MS4zMzQwNTcyLDI2LjY2MDc5OSBMNDAuOTM2OTY0OSwyNy4xNTQyMDAzIEM0MC42ODA0NzU3LDI3LjQ3OTcwNTMgNDAuNDE0MjYxNywyNy43OTczOTE1IDQwLjE1MjA5OTgsMjguMTE4MzY5OSBDMzkuMDkxNzAxMiwyOS4zOTQwNTMgMzguMDA3Mzk2LDMwLjY1MTIxODEgMzYuOTEyMTUwNiwzMS44OTk3NDE1IEwzNi41MDI5MDIzLDMyLjM2ODg2MzcgQzM2LjM0NjQ5NjYsMzIuNTcwMDkyNSAzNi4xODQ4MjMzLDMyLjc4OTgzOTIgMzYuMDI4ODIyNywzMy4wMDUwNTkyIEMzNS44OTEwNTYsMzMuMjM0NjgyMiAzNS43NTgxNTE2LDMzLjQ3MDQ3NzggMzUuNjI4ODk0LDMzLjcwOTE1NCBDMzUuNTIyNzMyNiwzMy45NTg5NDEgMzUuNDEwMDg4MSwzNC4yMDk5NjI1IDM1LjMyMTc1NTMsMzQuNDY5MjE0MyBDMzQuOTgzODIxNiwzNS41MTQwMzk5IDM0LjkwMzk5OCwzNi42NTg4NjI2IDM1LjEyMDc3NzksMzcuNzU2MzYxNiBDMzUuMzMzOTExMiwzOC44NTMwMzc2IDM1LjgzNDMyODUsMzkuOTA0MDM1OSAzNi41NzQ2MjIxLDQwLjc2NjE1MDcgQzM3LjMxMDA1MzMsNDEuNjMxNTU3NyAzOC4yOTM4Njk4LDQyLjI4NzkxNzIgMzkuMzUwMjE2NCw0Mi42NTI5MjcyIEM0MC40MDY1NjMsNDMuMDE1ODc5NiA0MS41ODA4MjE3LDQzLjEwMzUzMTQgNDIuNjgzMzYwNyw0Mi44NzE0Mzk0IEM0My43ODY3MTAxLDQyLjY0NDY5NyA0NC44MTM4ODI2LDQyLjEyMDQzMjQgNDUuNjQwNDgyOSw0MS4zODE3NzA3IEM0Ni40Njk5MTk2LDQwLjY0NTE2NjYgNDcuMDkyNzA2MywzOS42ODcxNjk3IDQ3LjQ1MDQ5NDYsMzguNjQ5MzM5OCBDNDcuNTM1OTkxLDM4LjM4ODg1MzUgNDcuNTk2NzcwNCwzOC4xMjAxMzcgNDcuNjYyNDEyMiwzNy44NTYzNTg3IEM0Ny43MDI1MjY2LDM3LjU4NzIzMDcgNDcuNzM4NTg5MSwzNy4zMTc2OTEyIDQ3Ljc2Njk1MjgsMzcuMDUwMjA5MyBDNDcuNzcyMjIwNCwzNi43ODM1NTAzIDQ3Ljc3NTg2NzIsMzYuNTA5MDcyNyA0Ny43NzIyMjA0LDM2LjI1MjcwMTYgTDQ3LjcyODg2NDQsMzUuNjI3MjA1MyBDNDcuNjMzNjQzMywzNC4zMTY5NTUzIDQ3LjU1MjE5ODgsMzMuMDA2NzA1MyA0Ny40ODE2OTQ3LDMxLjY5Njg2NjggTDQ5LjkwMTEyMTUsMzUuMzQyMDI4NCBMNTAuNzMyNTg0MiwzNC43NzI5MDkxIEM1My4wODQzNDMyLDMzLjE2MzA3OTMgNTMuNzA4MzQ1NCwyOS45MTA0OTg5IDUyLjEyMzYyMjksMjcuNTIxNjc5NCBMNTIuMTIzNjIyOSwyNy41MjE2Nzk0IFoiIGlkPSJ3aGl0ZSI+PC9wYXRoPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+';
    $grey_icon = 'PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMThweCIgaGVpZ2h0PSIyMHB4IiB2aWV3Qm94PSIwIDAgMTggMjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8dGl0bGU+Z3JleTwvdGl0bGU+CiAgICA8ZyBpZD0iUGFnZS0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0iLSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEwLjAwMDAwMCwgLTIzLjAwMDAwMCkiIGZpbGw9IiNBMEE1QUEiPgogICAgICAgICAgICA8cGF0aCBkPSJNMjIuMDg1MDA3NiwyNy40NTQ2MDMxIEMyMi4wNzIwNDEzLDI3LjQyMzczOTggMjIuMDU2MjM4NiwyNy4zOTQ1MjI2IDIyLjA0MjQ2MTksMjcuMzYzMjQ3OCBDMjMuMzAxNDA2NywyNy4wMjAwNDc5IDI0LjY5MjQ0NTQsMjcuNTAxOTI2OSAyNS40NjA2OTc1LDI4LjY1OTkxNzkgQzI2LjIzMTc4NiwyOS44MjIwMjQxIDI2LjE0NTQ3OTIsMzEuMzE5OTIzIDI1LjM1MTY5OTcsMzIuMzc3MDkzOSBMMjIuMDg1MDA3NiwyNy40NTQ2MDMxIFogTTIwLjU1MzM2NTcsMjkuMzUzMzEzNCBDMjAuNTM1OTQyMywyOS43Njk3NjIzIDIwLjUwNTk1NzgsMzAuMTg2MjExMSAyMC40ODEyNDA4LDMwLjYwMjI0ODQgQzIwLjM2NzM4MDcsMzIuMjY3NjMyMSAyMC4yMjM1MzYsMzMuOTMyNjA0MyAyMC4wNjU5MTQ2LDM1LjU5NzE2NSBMMjAuMDA4NzgyLDM2LjIyMTQyNjcgTDE5LjkyNzMzNzUsMzYuNjcwNzk2NCBMMTkuNzk1NjQ4OCwzNy4wOTA1MzczIEMxOS43Mjk2MDE4LDM3LjIyMTM5NzcgMTkuNjc2MTE1OSwzNy4zNTM5MDQxIDE5LjYxNTc0MTYsMzcuNDgxODg0IEMxOS4zNTM1Nzk2LDM3Ljk4ODA0MjEgMTguOTU4OTE4NSwzOC40MDI0MzM0IDE4LjUxMjc5NzQsMzguNzEwNjU0OSBDMTcuNjA4Mzk5NCwzOS4zMzIwMzYgMTYuNTEwMzE3NiwzOS40ODYzNTI1IDE1LjUyNDg4MDMsMzkuMTM3ODAzIEMxNC41MzMzNjUxLDM4LjgwNDg5MDggMTMuNzU0NTc3OSwzOC4wMDQwOTEgMTMuNDA5NzU1OSwzNi45NTE4NTgyIEMxMy4yMzk5Nzg3LDM2LjQzMDg4NTcgMTMuMTc1NTUyNSwzNS44NTg4ODU4IDEzLjI3MDc3MzYsMzUuMjk1MTE2MiBDMTMuMjk5NTQyNSwzNS4xNTY0MzcxIDEzLjMzNjQxNTQsMzUuMDE4MTY5NSAxMy4zNjI3NTMxLDM0Ljg3MzMxNzcgTDEzLjUwOTQzNDIsMzQuNDU4OTI2NSBMMTMuNzE0MDU4MywzNC4wNTE5NDI0IEwxNC4wNDMwNzc2LDMzLjUyMTUwNTIgQzE0LjkxNTQ2NTEsMzIuMTAzNDM5MyAxNS43OTkxOTgyLDMwLjY5MzE5MjIgMTYuNzA2ODM3OCwyOS4zMDE0NjMxIEMxNi45MzY1ODQsMjguOTU1Nzk0MSAxNy4xNjIyNzgzLDI4LjYwNzI0NDYgMTcuMzk4MTAyNiwyOC4yNjYxMDIyIEwxNy43NDMzMjk4LDI3Ljc2MjQxMzEgQzE3LjgzMTI1NzMsMjcuNjU3ODg5NCAxNy45MDc0MzQyLDI3LjUzNDQzNjIgMTguMDE2MDI2OCwyNy40NTg3MTgzIEMxOC40MDA5NjMzLDI3LjA4NDY1NSAxOC45OTEzMzQyLDI3LjAwNDgyMiAxOS41MjQxNjczLDI3LjE2ODE5MTcgQzIwLjA0NDg0NDQsMjcuMzY4MTg1OSAyMC40NjU0MzgxLDI3Ljc5NjE1NyAyMC41NDY4ODI2LDI4LjMzMTEyMDkgQzIwLjU4NzQwMjIsMjguNDU3ODY2MiAyMC41NzQwMzA3LDI4LjYwMzEyOTUgMjAuNTgwOTE5MSwyOC43NDA1NzQgTDIwLjU1MzM2NTcsMjkuMzUzMzEzNCBaIE0yNy4xMjM2MjI5LDI3LjUyMTY3OTQgQzI1Ljg0NzY1OTksMjUuNTk5MTAxNSAyMy41MjM4NTk0LDI0LjgxNTk5NjYgMjEuNDM4NzE5NSwyNS40MjI1NjM0IEwyMS43OTU2OTc0LDIzLjU2MDQ3NzYgTDIwLjIxODY3MzYsMjMgTDE4Ljk5Mzc2NTQsMjUuMzgzODgxNCBDMTguODA5ODA2MywyNS4zODE4MjM4IDE4LjYyNTg0NzIsMjUuMzg4ODE5NSAxOC40NDI2OTg1LDI1LjQxNzYyNTMgQzE3Ljg5NDg3MzIsMjUuNDkyOTMxNyAxNy4zNTg3OTg1LDI1LjczMDc4NDkgMTYuOTI1MjM4NSwyNi4wODAxNTc1IEMxNi42OTUwODcxLDI2LjI0NTU4NDggMTYuNTIwNDQ3NSwyNi40NTYyNzgyIDE2LjMzNDA1NzIsMjYuNjYwNzk5IEwxNS45MzY5NjQ5LDI3LjE1NDIwMDMgQzE1LjY4MDQ3NTcsMjcuNDc5NzA1MyAxNS40MTQyNjE3LDI3Ljc5NzM5MTUgMTUuMTUyMDk5OCwyOC4xMTgzNjk5IEMxNC4wOTE3MDEyLDI5LjM5NDA1MyAxMy4wMDczOTYsMzAuNjUxMjE4MSAxMS45MTIxNTA2LDMxLjg5OTc0MTUgTDExLjUwMjkwMjMsMzIuMzY4ODYzNyBDMTEuMzQ2NDk2NiwzMi41NzAwOTI1IDExLjE4NDgyMzMsMzIuNzg5ODM5MiAxMS4wMjg4MjI3LDMzLjAwNTA1OTIgQzEwLjg5MTA1NiwzMy4yMzQ2ODIyIDEwLjc1ODE1MTYsMzMuNDcwNDc3OCAxMC42Mjg4OTQsMzMuNzA5MTU0IEMxMC41MjI3MzI2LDMzLjk1ODk0MSAxMC40MTAwODgxLDM0LjIwOTk2MjUgMTAuMzIxNzU1MywzNC40NjkyMTQzIEM5Ljk4MzgyMTYxLDM1LjUxNDAzOTkgOS45MDM5OTc5NSwzNi42NTg4NjI2IDEwLjEyMDc3NzksMzcuNzU2MzYxNiBDMTAuMzMzOTExMiwzOC44NTMwMzc2IDEwLjgzNDMyODUsMzkuOTA0MDM1OSAxMS41NzQ2MjIxLDQwLjc2NjE1MDcgQzEyLjMxMDA1MzMsNDEuNjMxNTU3NyAxMy4yOTM4Njk4LDQyLjI4NzkxNzIgMTQuMzUwMjE2NCw0Mi42NTI5MjcyIEMxNS40MDY1NjMsNDMuMDE1ODc5NiAxNi41ODA4MjE3LDQzLjEwMzUzMTQgMTcuNjgzMzYwNyw0Mi44NzE0Mzk0IEMxOC43ODY3MTAxLDQyLjY0NDY5NyAxOS44MTM4ODI2LDQyLjEyMDQzMjQgMjAuNjQwNDgyOSw0MS4zODE3NzA3IEMyMS40Njk5MTk2LDQwLjY0NTE2NjYgMjIuMDkyNzA2MywzOS42ODcxNjk3IDIyLjQ1MDQ5NDYsMzguNjQ5MzM5OCBDMjIuNTM1OTkxLDM4LjM4ODg1MzUgMjIuNTk2NzcwNCwzOC4xMjAxMzcgMjIuNjYyNDEyMiwzNy44NTYzNTg3IEMyMi43MDI1MjY2LDM3LjU4NzIzMDcgMjIuNzM4NTg5MSwzNy4zMTc2OTEyIDIyLjc2Njk1MjgsMzcuMDUwMjA5MyBDMjIuNzcyMjIwNCwzNi43ODM1NTAzIDIyLjc3NTg2NzIsMzYuNTA5MDcyNyAyMi43NzIyMjA0LDM2LjI1MjcwMTYgTDIyLjcyODg2NDQsMzUuNjI3MjA1MyBDMjIuNjMzNjQzMywzNC4zMTY5NTUzIDIyLjU1MjE5ODgsMzMuMDA2NzA1MyAyMi40ODE2OTQ3LDMxLjY5Njg2NjggTDI0LjkwMTEyMTUsMzUuMzQyMDI4NCBMMjUuNzMyNTg0MiwzNC43NzI5MDkxIEMyOC4wODQzNDMyLDMzLjE2MzA3OTMgMjguNzA4MzQ1NCwyOS45MTA0OTg5IDI3LjEyMzYyMjksMjcuNTIxNjc5NCBMMjcuMTIzNjIyOSwyNy41MjE2Nzk0IFoiIGlkPSJncmV5Ij48L3BhdGg+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=';

    $active = isset($_GET['page']) && $_GET['page'] === 'prepear';

    add_menu_page(
        'Prepear',
        'Prepear',
        'manage_options',
        'prepear',
        'prepear_admin_page_init',
        'data:image/svg+xml;base64,' . ($active ? $white_icon : $grey_icon),
        '57.95'
    );
}

function prpr_verify_domain()
{
    // Not verifying a nonce here to allow the prepear servers to make the request server to server.
    global $prepear_auth;

    $domain = $_SERVER['HTTP_HOST'];
    $cookies[] = new WP_Http_Cookie(array('name' => 'ppi', 'value' => $prepear_auth));
    $response = wp_remote_get('https://app.prepear.com/api/v2/domains/' . $domain, array(
        'cookies' => $cookies
    ));

    echo json_decode($response['body'])->secret;

    wp_die();
}

function prepear_admin_page_init()
{
    global $prepear_auth;

    ?>

    <div class="wrap">
        <img src="<?php echo PREPEAR_URL . 'img/logo@2x.png' ?>" width="150" alt="Prepear logo" style="margin-top: 10px">
        <?php if ($prepear_auth) {
            prepear_admin_logged_in();
        } else {
            prepear_admin_link_account();
        }
        ?>
    </div>

    <?php
}

function prepear_admin_logged_in()
{
    prepear_admin_prepear_it();
    ?>

    <br>
    <p>Please return to Prepear if you need to finish verifying your domain.</p>

    <form action="<?php echo admin_url('admin-post.php') ?>" method="post">
        <?php wp_nonce_field('prepear_logout_user') ?>
        <input type="hidden" name="action" value="prepear_logout_user">
        <input type="submit" name="prepear_logout_user" value="Unlink Prepear" class="button" />
    </form>

    <?php
}
